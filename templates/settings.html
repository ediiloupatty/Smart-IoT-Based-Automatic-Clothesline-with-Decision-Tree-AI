<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Sistem | Smart Clothesline System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div id="theme-loading-screen">
        <div class="loader"></div>
    </div>
    <header id="main-header">
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-cloud-sun"></i>
                <span>Smart Clothesline System</span>
            </div>
            <div class="nav-links">
                <a href="/">Beranda</a>
                <a href="/realtime-monitoring">Real-time Monitoring</a>
                <a href="/control">Kontrol Manual</a>
                <a href="/settings" class="active">Pengaturan Sistem</a>
            </div>
        </div>
    </header>

    <div class="container main-content">
        <div id="alert-success" class="alert alert-success">
            <i class="fas fa-check-circle"></i> Pengaturan berhasil disimpan!
        </div>
        <div id="alert-danger" class="alert alert-danger">
            <i class="fas fa-exclamation-circle"></i> Gagal menyimpan pengaturan. Silakan coba lagi.
        </div>
        
        <div class="dashboard">
            <div class="card">
                <h2>Pengaturan Tampilan</h2>
                <div class="form-group theme-switch-wrapper">
                    <label for="dark-mode">
                        <span class="theme-switch-icon" id="theme-icon"><i class="fas fa-sun"></i></span>
                        Mode Tampilan:
                    </label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode">
                        <span class="slider"></span>
                    </label>
                    <span id="theme-text" style="margin-left: 10px;">Mode Terang</span>
                </div>
            </div>
            
            <div class="card">
                <h2>Pengaturan Koneksi</h2>
                <form id="settings-form">
                    <div class="form-group">
                        <label for="base-url">URL API:</label>
                        <input type="text" id="base-url" name="base-url" placeholder="http://192.168.137.93/">
                        <small>URL NodeMCU atau Server API (contoh: http://192.168.137.93/ atau https://iot-clothesline-system.onrender.com)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="connection-timeout">Batas Waktu Koneksi (detik):</label>
                        <input type="number" id="connection-timeout" name="connection-timeout" min="1" max="30" step="1" value="5">
                    </div>
                    
                    <button type="submit" id="save-config">Simpan Konfigurasi</button>
                    <button type="button" id="test-connection" class="secondary-button">
                        <i class="fas fa-network-wired"></i> Tes Koneksi
                    </button>
                    <span id="connection-status"></span>
                </form>
            </div>
            
            <div class="card">
                <h2>Pengaturan Mode Otomatis</h2>
                <div class="auto-settings-container">
                    <div class="form-group">
                        <label>Mode Otomatis:</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="auto-mode">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="form-group">
                        <label for="light-threshold">Batas Intensitas Cahaya:</label>
                        <input type="range" id="light-threshold" name="light-threshold" min="0" max="1023" value="500">
                        <div class="threshold-display">
                            Nilai: <span id="light-threshold-value" class="threshold-value">500</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="rain-threshold">Sensitivitas Hujan:</label>
                        <input type="range" id="rain-threshold" name="rain-threshold" min="0" max="1023" value="500">
                        <div class="threshold-display">
                            Nilai: <span id="rain-threshold-value" class="threshold-value">500</span>
                        </div>
                    </div>
                    
                    <button id="save-auto-settings">Simpan Pengaturan Otomatis</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Model Prediksi Cuaca</h2>
            <div class="data-item">
                <span>Status Model Saat Ini:</span>
                <span id="model-status">Belum Dilatih</span>
            </div>
            <div class="data-item">
                <span>Tanggal Pelatihan Terakhir:</span>
                <span id="last-training">-</span>
            </div>
            <div class="data-item">
                <span>Akurasi Model:</span>
                <span id="model-accuracy">-</span>
            </div>
            <button id="train-model"><i class="fas fa-sync"></i> Latih Model Prediksi Cuaca</button>
            <p style="margin-top: 15px; font-size: 14px; color: #666;">
                Pelatihan model akan menggunakan data sensor historis untuk meningkatkan akurasi prediksi cuaca.
                Proses ini mungkin memakan waktu beberapa menit tergantung jumlah data.
            </p>
        </div>
        
        <div class="card">
            <h2>Data Sensor</h2>
            <button id="view-data-button" class="secondary-button">
                <i class="fas fa-table"></i> Lihat Data Sensor
            </button>
            <div id="data-container" style="display: none; margin-top: 15px;">
                <div class="table-container">
                    <table id="data-table" class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Waktu</th>
                                <th>Cahaya</th>
                                <th>Hujan</th>
                                <th>Status</th>
                                <th>Rotasi</th>
                            </tr>
                        </thead>
                        <tbody id="data-tbody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 Smart Clothesline System. Hak cipta dilindungi.</p>
        <p>IoT Innovation Lab</p>
    </footer>

    <script>
        // Tema gelap (dark mode) functionality
        const darkModeToggle = document.getElementById('dark-mode');
        const themeIcon = document.getElementById('theme-icon');
        const themeText = document.getElementById('theme-text');

        // Check for saved theme preference or use system preference
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme');

        if (currentTheme === 'dark') {
            document.documentElement.setAttribute('data-theme', 'dark');
            darkModeToggle.checked = true;
            themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
            themeText.textContent = 'Mode Gelap';
        } else if (currentTheme === 'light') {
            document.documentElement.setAttribute('data-theme', 'light');
            darkModeToggle.checked = false;
            themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
            themeText.textContent = 'Mode Terang';
        } else if (prefersDarkScheme.matches) {
            document.documentElement.setAttribute('data-theme', 'dark');
            darkModeToggle.checked = true;
            themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
            themeText.textContent = 'Mode Gelap';
        }

        // Listen for toggle changes
        // Modifikasi event listener dark mode toggle
        darkModeToggle.addEventListener('change', function() {
            // Tampilkan loading screen
            const loadingScreen = document.getElementById('theme-loading-screen');
            loadingScreen.classList.add('active');
            
            // Delay sedikit untuk memastikan transisi dimulai
            setTimeout(() => {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                    themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
                    themeText.textContent = 'Mode Gelap';
                    console.log('Dark mode activated');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                    localStorage.setItem('theme', 'light');
                    themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
                    themeText.textContent = 'Mode Terang';
                    console.log('Light mode activated');
                }
                
                // Beri waktu 500ms untuk transisi tema selesai
                // lalu sembunyikan loading screen
                setTimeout(() => {
                    loadingScreen.classList.remove('active');
                }, 500);
            }, 100);
        });

        // Update threshold value displays with visual feedback
        document.getElementById('light-threshold').addEventListener('input', function() {
            const value = this.value;
            document.getElementById('light-threshold-value').textContent = value;
            
            // Add visual feedback for threshold ranges
            if (value < 200) {
                document.getElementById('light-threshold-value').style.color = '#3498db'; // Blue for low light
            } else if (value > 800) {
                document.getElementById('light-threshold-value').style.color = '#f39c12'; // Orange for high light
            } else {
                document.getElementById('light-threshold-value').style.color = '#2ecc71'; // Green for mid range
            }
        });

        document.getElementById('rain-threshold').addEventListener('input', function() {
            const value = this.value;
            document.getElementById('rain-threshold-value').textContent = value;
            
            // Add visual feedback for threshold ranges
            if (value < 200) {
                document.getElementById('rain-threshold-value').style.color = '#3498db'; // Blue for dry
            } else if (value > 800) {
                document.getElementById('rain-threshold-value').style.color = '#9b59b6'; // Purple for wet
            } else {
                document.getElementById('rain-threshold-value').style.color = '#2ecc71'; // Green for mid range
            }
        });

        // Form submission handler - updated to match app.py route
        document.getElementById('settings-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const config = {
                base_url: document.getElementById('base-url').value,
                timeout: parseFloat(document.getElementById('connection-timeout').value)
            };
            
            saveSystemConfig(config);
        });

        // Enhanced Auto Settings handler with confirmation - matches app.py route
        document.getElementById('save-auto-settings').addEventListener('click', function() {
            // Get current values
            const autoEnabled = document.getElementById('auto-mode').checked;
            const lightThreshold = parseInt(document.getElementById('light-threshold').value);
            const rainThreshold = parseInt(document.getElementById('rain-threshold').value);
            
            // Show a confirmation dialog when enabling auto mode
            if (autoEnabled) {
                const confirmEnable = confirm(
                    "Mengaktifkan Mode Otomatis akan mengizinkan sistem untuk mengendalikan jemuran Anda " +
                    "secara otomatis berdasarkan kondisi cuaca.\n\n" +
                    "Batas Cahaya: " + lightThreshold + "\n" +
                    "Batas Hujan: " + rainThreshold + "\n\n" +
                    "Apakah Anda yakin ingin mengaktifkan Mode Otomatis?"
                );
                
                if (!confirmEnable) {
                    document.getElementById('auto-mode').checked = false;
                    return;
                }
            }
            
            const autoSettings = {
                enabled: autoEnabled,
                lightThreshold: lightThreshold,
                rainThreshold: rainThreshold
            };
            
            saveAutoSettings(autoSettings);
        });

        // Test connection button handler - updated to match app.py route
        document.getElementById('test-connection').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menguji...';
            const connectionStatus = document.getElementById('connection-status');
            connectionStatus.textContent = 'Memeriksa koneksi...';
            connectionStatus.className = '';
            
            fetch('/check-nodemcu')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        connectionStatus.textContent = 'Terhubung dengan sukses!';
                        connectionStatus.className = 'text-success';
                    } else {
                        connectionStatus.textContent = `Gagal: ${data.message}`;
                        connectionStatus.className = 'text-danger';
                    }
                })
                .catch(error => {
                    connectionStatus.textContent = `Error: ${error.message}`;
                    connectionStatus.className = 'text-danger';
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-network-wired"></i> Tes Koneksi';
                });
        });

        // Train model handler - matches app.py route
        document.getElementById('train-model').addEventListener('click', function() {
            this.disabled = true;
            this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Melatih model...';
            
            fetch('/train-model', {
                method: 'POST'
            })
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || 'Terjadi kesalahan yang tidak diketahui');
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.accuracy) {
                        document.getElementById('model-status').textContent = 'Sudah Dilatih';
                        document.getElementById('last-training').textContent = new Date().toLocaleString();
                        document.getElementById('model-accuracy').textContent = (data.accuracy * 100).toFixed(2) + '%';
                        
                        showAlert('success', 'Model berhasil dilatih!');
                    } else {
                        showAlert('danger', 'Gagal melatih model: ' + (data.error || 'Kesalahan tidak diketahui'));
                    }
                })
                .catch(error => {
                    console.error('Error details:', error);
                    showAlert('danger', 'Gagal melatih model: ' + error.message);
                })
                .finally(() => {
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-sync"></i> Latih Model Prediksi Cuaca';
                });
        });

        // Data viewer button handler - matches app.py route
        document.getElementById('view-data-button').addEventListener('click', function() {
            const dataContainer = document.getElementById('data-container');
            
            if (dataContainer.style.display === 'none') {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memuat data...';
                this.disabled = true;
                
                fetch('/view-data')
                    .then(response => response.json())
                    .then(data => {
                        const tbody = document.getElementById('data-tbody');
                        tbody.innerHTML = '';
                        
                        if (data.length === 0) {
                            const row = document.createElement('tr');
                            row.innerHTML = '<td colspan="6" class="text-center">Tidak ada data sensor tersedia</td>';
                            tbody.appendChild(row);
                        } else {
                            data.forEach(record => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${record.id}</td>
                                    <td>${record.timestamp}</td>
                                    <td>${record.ldr}</td>
                                    <td>${record.rain}</td>
                                    <td>${record.status}</td>
                                    <td>${record.rotation}</td>
                                `;
                                tbody.appendChild(row);
                            });
                        }
                        
                        dataContainer.style.display = 'block';
                        this.innerHTML = '<i class="fas fa-eye-slash"></i> Sembunyikan Data Sensor';
                    })
                    .catch(error => {
                        console.error('Error loading data:', error);
                        showAlert('danger', 'Gagal memuat data sensor');
                    })
                    .finally(() => {
                        this.disabled = false;
                    });
            } else {
                dataContainer.style.display = 'none';
                this.innerHTML = '<i class="fas fa-table"></i> Lihat Data Sensor';
            }
        });

        // Save system configuration - matches app.py route
        function saveSystemConfig(config) {
            fetch('/save-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(config)
            })
            .then(response => {
                if (!response.ok) throw new Error('Gagal menyimpan');
                return response.json();
            })
            .then(data => {
                showAlert('success', 'Pengaturan koneksi berhasil disimpan!');
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Gagal menyimpan konfigurasi');
            });
        }

        // Save auto mode settings - matches app.py route
        function saveAutoSettings(settings) {
            fetch('/save-auto-settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(settings)
            })
            .then(response => {
                if (!response.ok) throw new Error('Gagal menyimpan');
                return response.json();
            })
            .then(data => {
                showAlert('success', 'Pengaturan mode otomatis berhasil disimpan!');
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('danger', 'Gagal menyimpan pengaturan mode otomatis');
            });
        }

        // Show alert messages
        function showAlert(type, message) {
            const alert = document.getElementById(`alert-${type}`);
            alert.textContent = message;
            alert.style.display = 'block';
            
            setTimeout(() => {
                alert.style.display = 'none';
            }, 3000);
        }

        // Load current settings when page loads - matches app.py routes
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentSettings();
        });

        function loadCurrentSettings() {
            // Load system config
            fetch('/get-config')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('base-url').value = data.base_url || '';
                    document.getElementById('connection-timeout').value = data.timeout || '5';
                })
                .catch(error => console.error('Error loading config:', error));
            
            // Load auto settings
            fetch('/get-auto-settings')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('auto-mode').checked = data.enabled;
                    document.getElementById('light-threshold').value = data.lightThreshold;
                    document.getElementById('rain-threshold').value = data.rainThreshold;
                    
                    // Update displays and apply color coding
                    const lightThreshold = data.lightThreshold;
                    const rainThreshold = data.rainThreshold;
                    const lightEl = document.getElementById('light-threshold-value');
                    const rainEl = document.getElementById('rain-threshold-value');
                    
                    lightEl.textContent = lightThreshold;
                    rainEl.textContent = rainThreshold;
                    
                    // Set colors based on values
                    if (lightThreshold < 200) {
                        lightEl.style.color = '#3498db'; // Blue for low light
                    } else if (lightThreshold > 800) {
                        lightEl.style.color = '#f39c12'; // Orange for high light
                    } else {
                        lightEl.style.color = '#2ecc71'; // Green for mid range
                    }
                    
                    if (rainThreshold < 200) {
                        rainEl.style.color = '#3498db'; // Blue for dry
                    } else if (rainThreshold > 800) {
                        rainEl.style.color = '#9b59b6'; // Purple for wet
                    } else {
                        rainEl.style.color = '#2ecc71'; // Green for mid range
                    }
                })
                .catch(error => console.error('Error loading auto settings:', error));
            
            // Load model info
            fetch('/get-model-info')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('model-status').textContent = data.trained ? 'Sudah Dilatih' : 'Belum Dilatih';
                    document.getElementById('last-training').textContent = data.lastTraining || '-';
                    document.getElementById('model-accuracy').textContent = data.accuracy ? (data.accuracy * 100).toFixed(2) + '%' : '-';
                })
                .catch(error => console.error('Error loading model info:', error));
        }
    </script>
</body>
</html>